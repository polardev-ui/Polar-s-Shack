<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Polar's Shack — Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="../logo.png">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
:root {
  --bg:#111;
  --card:#1e1e1e;
  --muted:#666;
  --accent:#00ff00;
  --danger:#ff6666;
  --panel:#0f0f0f;
  --border:#333;
}
* { box-sizing: border-box; margin:0; padding:0; }
body {
  font-family:'JetBrains Mono', monospace;
  background:linear-gradient(180deg,#0b0b0b,var(--bg));
  color:#ddd;
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* Enhanced navbar with settings button */
.navbar {
  background:#1a1a1a;
  padding:1rem 1.5rem;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:60;
  backdrop-filter:blur(10px);
}
.logo-nav {display:flex;gap:.75rem;align-items:center;}
.logo-nav img {width:34px;height:34px;border-radius:6px;}
.logo-nav span {color:#fff;font-weight:600;font-size:1.1rem;}
.nav-links {display:flex;gap:1.5rem;align-items:center;}
.nav-links a {color:#aaa;text-decoration:none;padding:.4rem .6rem;border-radius:6px;transition:all .2s;}
.nav-links a.active, .nav-links a:hover {color:var(--accent);background:rgba(0,255,0,0.05);}
.nav-btn {background:#2a2a2a;border:1px solid var(--border);color:#aaa;padding:.5rem .9rem;border-radius:8px;cursor:pointer;transition:all .2s;font-family:'JetBrains Mono',monospace;font-size:.9rem;display:flex;align-items:center;gap:.5rem;}
.nav-btn:hover {background:#333;border-color:var(--accent);color:var(--accent);}

/* Three-column layout: users | chat | room-selector */
.layout {
  display:flex;
  height:calc(100vh - 70px);
  width:100%;
  overflow:hidden;
}

/* Users panel with profile click */
.users-panel {
  width:240px;
  background:var(--panel);
  border-right:1px solid var(--border);
  padding:.75rem;
  overflow-y:auto;
  box-shadow:0 6px 18px rgba(0,0,0,0.5);
}
.users-panel h3 {color:var(--accent);margin:.15rem 0 .75rem;font-size:1rem;text-transform:uppercase;letter-spacing:1px;}
.user-row {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:.6rem .7rem;
  border-radius:8px;
  transition:all .15s;
  cursor:pointer;
  border:1px solid transparent;
}
.user-row:hover {background:#151515;transform:translateY(-1px);border-color:var(--accent);}
.user-name {
  color:#fff;
  font-weight:600;
  font-size:.95rem;
  max-width:140px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.user-meta {font-size:.75rem;color:var(--muted);}
.badge-admin {color:var(--danger);font-weight:700;margin-left:.4rem;font-size:.75rem;}
.status-dot {
  width:8px;
  height:8px;
  border-radius:50%;
  display:inline-block;
  margin-right:.4rem;
}
.status-dot.online {background:var(--accent);box-shadow:0 0 8px var(--accent);}
.status-dot.offline {background:#444;}

/* Chat card with room switcher */
.chat-card {
  flex:1;
  display:flex;
  flex-direction:column;
  background:linear-gradient(180deg,#121212,#161616);
  border-left:1px solid var(--border);
  overflow:hidden;
  box-shadow:0 10px 30px rgba(0,0,0,0.6);
}
.chat-header {
  padding:1rem 1.25rem;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:1rem;
  background:#1a1a1a;
}
.chat-header .title {color:var(--accent);font-weight:700;font-size:1.1rem;}
.chat-header .right {font-size:.9rem;color:var(--muted);display:flex;gap:.75rem;align-items:center;}

/* Room selector tabs */
.room-tabs {
  display:flex;
  gap:.5rem;
  padding:.75rem 1rem;
  background:#0f0f0f;
  border-bottom:1px solid var(--border);
  overflow-x:auto;
}
.room-tab {
  padding:.5rem 1rem;
  background:#2a2a2a;
  border:1px solid var(--border);
  border-radius:8px;
  color:#888;
  cursor:pointer;
  transition:all .2s;
  white-space:nowrap;
  font-size:.85rem;
  display:flex;
  align-items:center;
  gap:.5rem;
}
.room-tab.active {background:var(--accent);color:#000;border-color:var(--accent);font-weight:600;}
.room-tab:hover:not(.active) {background:#333;border-color:var(--accent);color:var(--accent);}
.room-tab .close-dm {
  margin-left:.3rem;
  opacity:.6;
  transition:opacity .2s;
}
.room-tab .close-dm:hover {opacity:1;}

/* Messages with reply support */
.messages {
  flex:1;
  padding:1rem;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:.6rem;
  scroll-behavior:smooth;
  background:radial-gradient(1200px 200px at 10% 0%, rgba(0,255,0,0.01), transparent 2%),transparent;
}
.msg {
  max-width:75%;
  padding:.7rem .95rem;
  border-radius:12px;
  display:inline-block;
  line-height:1.3;
  animation:enter .2s ease;
  box-shadow:0 2px 8px rgba(0,0,0,0.5);
  position:relative;
}
.msg .meta {display:block;font-size:.8rem;color:var(--muted);margin-bottom:.3rem;display:flex;align-items:center;gap:.5rem;}
.msg .meta .username {font-weight:600;}
.msg .content {margin-top:.2rem;}
.msg.me {align-self:flex-end;background:var(--accent);color:#050505;border-bottom-right-radius:4px;}
.msg.other {align-self:flex-start;background:#1a1a1a;color:#ddd;border-bottom-left-radius:4px;border:1px solid var(--border);}
.msg.system {align-self:center;background:transparent;color:#888;font-style:italic;padding:.3rem .6rem;border-radius:6px;max-width:90%;}
.admin-tag {color:var(--danger);font-weight:700;margin-left:.45rem;font-size:.75rem;}

/* Reply preview in message */
.reply-preview {
  background:rgba(0,0,0,0.3);
  padding:.4rem .6rem;
  border-left:3px solid var(--accent);
  border-radius:4px;
  margin-bottom:.4rem;
  font-size:.8rem;
  color:#aaa;
}
.reply-preview .reply-to {font-weight:600;color:var(--accent);margin-bottom:.2rem;}

/* Message actions (reply button) */
.msg-actions {
  position:absolute;
  top:.5rem;
  right:.5rem;
  display:none;
  gap:.3rem;
}
.msg:hover .msg-actions {display:flex;}
.msg-action-btn {
  background:rgba(0,0,0,0.6);
  border:1px solid rgba(255,255,255,0.1);
  color:#aaa;
  padding:.3rem .5rem;
  border-radius:4px;
  cursor:pointer;
  font-size:.75rem;
  transition:all .2s;
}
.msg-action-btn:hover {background:rgba(0,255,0,0.1);border-color:var(--accent);color:var(--accent);}

@keyframes enter { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }

/* Input bar with reply indicator */
.input-bar {
  display:flex;
  flex-direction:column;
  gap:.5rem;
  padding:.9rem 1rem;
  border-top:1px solid var(--border);
  background:linear-gradient(180deg,#0f0f0f,#131313);
}
.reply-indicator {
  display:none;
  background:#2a2a2a;
  padding:.5rem .75rem;
  border-radius:8px;
  border-left:3px solid var(--accent);
  font-size:.85rem;
  color:#aaa;
  align-items:center;
  justify-content:space-between;
}
.reply-indicator.active {display:flex;}
.reply-indicator .cancel-reply {
  background:transparent;
  border:none;
  color:var(--danger);
  cursor:pointer;
  font-size:1.1rem;
  padding:.2rem;
}
.input-row {display:flex;gap:.6rem;align-items:center;}
.input-row input {
  flex:1;
  padding:14px 16px;
  border-radius:10px;
  border:2px solid var(--border);
  background:#1f1f1f;
  color:#fff;
  outline:none;
  font-size:1rem;
  font-family:'JetBrains Mono',monospace;
  transition:border-color .2s;
}
.input-row input:focus {border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,255,0,0.1);}
.send-btn {
  background:var(--accent);
  border:none;
  padding:12px 18px;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
  transition:all .15s;
  color:#000;
  font-family:'JetBrains Mono',monospace;
}
.send-btn:hover {filter:brightness(1.1);transform:translateY(-1px);}
.send-btn:active {transform:scale(.98);}

/* Modals (auth, profile, settings, ban) */
.modal-overlay {
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.8);
  z-index:200;
  backdrop-filter:blur(4px);
}
.modal-overlay.active {display:flex;}
.modal-content {
  background:#1c1c1c;
  padding:2rem;
  border-radius:16px;
  border:1px solid var(--border);
  max-width:500px;
  width:92%;
  max-height:85vh;
  overflow-y:auto;
  box-shadow:0 20px 60px rgba(0,0,0,0.8);
  animation:modalEnter .3s ease;
}
@keyframes modalEnter { from{opacity:0;transform:scale(.95)} to{opacity:1;transform:scale(1)} }
.modal-content h2 {color:var(--accent);margin:0 0 1rem;text-align:center;font-size:1.5rem;}
.modal-content .form-group {margin-bottom:1rem;}
.modal-content .form-group label {display:block;color:#aaa;margin-bottom:.5rem;font-size:.9rem;}
.modal-content .form-group input {
  width:100%;
  padding:12px 14px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#222;
  color:#fff;
  outline:none;
  font-family:'JetBrains Mono',monospace;
  transition:border-color .2s;
}
.modal-content .form-group input:focus {border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,255,0,0.1);}
.modal-content .btn-group {display:flex;gap:.75rem;margin-top:1.5rem;}
.modal-content .btn {
  flex:1;
  padding:12px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-weight:600;
  font-family:'JetBrains Mono',monospace;
  transition:all .2s;
}
.modal-content .btn-primary {background:var(--accent);color:#000;}
.modal-content .btn-primary:hover {filter:brightness(1.1);}
.modal-content .btn-secondary {background:#2a2a2a;color:#fff;border:1px solid var(--border);}
.modal-content .btn-secondary:hover {background:#333;border-color:var(--accent);color:var(--accent);}
.modal-content .error-msg {color:var(--danger);font-size:.85rem;margin-top:.5rem;display:none;}
.modal-content .info-msg {color:#aaa;font-size:.85rem;margin-top:.5rem;text-align:center;}

/* Profile modal */
.profile-modal .profile-header {
  text-align:center;
  margin-bottom:1.5rem;
  padding-bottom:1rem;
  border-bottom:1px solid var(--border);
}
.profile-modal .profile-avatar {
  width:80px;
  height:80px;
  border-radius:50%;
  background:linear-gradient(135deg,var(--accent),#00aa00);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:2rem;
  color:#000;
  font-weight:700;
  margin:0 auto 1rem;
  box-shadow:0 4px 20px rgba(0,255,0,0.3);
}
.profile-modal .profile-username {font-size:1.3rem;color:#fff;font-weight:600;margin-bottom:.3rem;}
.profile-modal .profile-status {font-size:.85rem;color:var(--muted);}
.profile-modal .profile-bio {
  background:#222;
  padding:1rem;
  border-radius:8px;
  border:1px solid var(--border);
  margin-bottom:1rem;
  color:#aaa;
  font-size:.9rem;
  line-height:1.5;
  min-height:60px;
}
.profile-modal .profile-actions {display:flex;gap:.75rem;}
.profile-modal .profile-actions .btn {flex:1;}

/* Settings modal */
.settings-modal .settings-section {margin-bottom:1.5rem;padding-bottom:1.5rem;border-bottom:1px solid var(--border);}
.settings-modal .settings-section:last-child {border-bottom:none;}
.settings-modal .settings-section h3 {color:#fff;font-size:1.1rem;margin-bottom:1rem;}
.settings-modal .setting-item {display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;}
.settings-modal .setting-item label {color:#aaa;font-size:.9rem;}
.settings-modal .toggle-switch {
  position:relative;
  width:50px;
  height:26px;
  background:#333;
  border-radius:13px;
  cursor:pointer;
  transition:background .2s;
}
.settings-modal .toggle-switch.active {background:var(--accent);}
.settings-modal .toggle-switch::after {
  content:'';
  position:absolute;
  width:20px;
  height:20px;
  border-radius:50%;
  background:#fff;
  top:3px;
  left:3px;
  transition:left .2s;
}
.settings-modal .toggle-switch.active::after {left:27px;}

/* Ban modal */
.ban-modal {
  background:#1c1c1c;
  padding:2rem;
  border-radius:16px;
  border:2px solid var(--danger);
  max-width:450px;
  text-align:center;
  box-shadow:0 20px 60px rgba(255,102,102,0.3);
}
.ban-modal h3 {color:var(--danger);margin:0 0 1rem;font-size:1.5rem;}
.ban-modal p {color:#ddd;margin:.75rem 0 1.5rem;font-size:.95rem;line-height:1.5;}
.ban-modal .btn {
  background:#333;
  color:#fff;
  border:1px solid var(--border);
  padding:12px 24px;
  border-radius:8px;
  cursor:pointer;
  font-family:'JetBrains Mono',monospace;
  font-weight:600;
}
.ban-modal .btn:hover {background:#3a3a3a;}

/* Add custom context menu styles */
.context-menu {
  position:fixed;
  background:#1c1c1c;
  border:1px solid var(--border);
  border-radius:8px;
  padding:.5rem 0;
  min-width:180px;
  box-shadow:0 10px 30px rgba(0,0,0,0.8);
  z-index:9999;
  display:none;
}
.context-menu.active {display:block;}
.context-menu-item {
  padding:.7rem 1rem;
  color:#ddd;
  cursor:pointer;
  transition:all .15s;
  display:flex;
  align-items:center;
  gap:.6rem;
  font-size:.85rem;
}
.context-menu-item:hover {
  background:rgba(0,255,0,0.1);
  color:var(--accent);
}
.context-menu-item.danger {color:var(--danger);}
.context-menu-item.danger:hover {background:rgba(255,102,102,0.1);}

/* Add admin notification popup styles */
.admin-notification {
  position:fixed;
  top:80px;
  right:20px;
  background:#1c1c1c;
  border:2px solid var(--danger);
  border-radius:12px;
  padding:1rem 1.25rem;
  min-width:300px;
  max-width:400px;
  box-shadow:0 10px 40px rgba(255,102,102,0.4);
  z-index:9999;
  animation:slideIn .3s ease;
  display:none;
}
.admin-notification.active {display:block;}
.admin-notification .notif-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:.75rem;
}
.admin-notification .notif-title {
  color:var(--danger);
  font-weight:700;
  font-size:1rem;
  display:flex;
  align-items:center;
  gap:.5rem;
}
.admin-notification .notif-close {
  background:transparent;
  border:none;
  color:#888;
  cursor:pointer;
  font-size:1.3rem;
  padding:0;
  transition:color .2s;
}
.admin-notification .notif-close:hover {color:var(--danger);}
.admin-notification .notif-body {
  color:#ddd;
  font-size:.85rem;
  line-height:1.4;
}
.admin-notification .notif-meta {
  color:#888;
  font-size:.75rem;
  margin-top:.5rem;
  padding-top:.5rem;
  border-top:1px solid var(--border);
}
@keyframes slideIn {
  from {transform:translateX(400px);opacity:0;}
  to {transform:translateX(0);opacity:1;}
}

/* Add chat shutdown modal styles */
.shutdown-modal {
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.9);
  z-index:9999;
  backdrop-filter:blur(8px);
}
.shutdown-modal.active {display:flex;}
.shutdown-content {
  background:#1c1c1c;
  padding:2.5rem;
  border-radius:16px;
  border:2px solid var(--danger);
  max-width:500px;
  width:92%;
  text-align:center;
  box-shadow:0 20px 60px rgba(255,102,102,0.4);
  animation:modalEnter .3s ease;
}
.shutdown-icon {
  font-size:4rem;
  color:var(--danger);
  margin-bottom:1rem;
}
.shutdown-content h2 {
  color:var(--danger);
  font-size:1.8rem;
  margin-bottom:1rem;
}
.shutdown-content p {
  color:#aaa;
  font-size:1rem;
  line-height:1.6;
  margin-bottom:1.5rem;
}

/* Responsive */
@media (max-width:900px){
  .layout {flex-direction:column;}
  .users-panel {
    order:2;
    height:140px;
    display:flex;
    flex-direction:row;
    gap:.5rem;
    overflow-x:auto;
    width:100%;
    border-right:none;
    border-top:1px solid var(--border);
  }
  .users-panel .user-row {min-width:140px;flex-direction:column;align-items:flex-start;}
  .chat-card {height:calc(100vh - 210px);}
  .room-tabs {padding:.5rem .75rem;}
  .room-tab {padding:.4rem .8rem;font-size:.8rem;}
}
  </style>
</head>
<body>
  <!-- Enhanced navbar with settings -->
  <nav class="navbar">
    <div class="logo-nav">
      <img src="../logo.png" alt="logo">
      <span>polar's.shack</span>
    </div>
    <div class="nav-links">
      <a href="index.html">home</a>
      <a href="chat.html" class="active">chat</a>
      <button id="settingsBtn" class="nav-btn"><i class='bx bx-cog'></i> settings</button>
      <button id="logoutBtn" class="nav-btn"><i class='bx bx-log-out'></i> logout</button>
    </div>
  </nav>

  <div class="layout">
    <!-- Users panel with click to view profile -->
    <aside class="users-panel">
      <h3>online users</h3>
      <div id="usersList"></div>
    </aside>

    <section class="chat-card">
      <!-- Room tabs for public + DMs -->
      <div class="room-tabs" id="roomTabs">
        <div class="room-tab active" data-room="public">
          <i class='bx bx-globe'></i> public chat
        </div>
      </div>

      <div class="chat-header">
        <div class="title" id="chatTitle">public chat</div>
        <div class="right">
          <span id="meDisplay">@guest</span>
        </div>
      </div>

      <div id="messages" class="messages"></div>

      <!-- Input bar with reply indicator -->
      <div class="input-bar">
        <div class="reply-indicator" id="replyIndicator">
          <span id="replyText">replying to...</span>
          <button class="cancel-reply" id="cancelReply"><i class='bx bx-x'></i></button>
        </div>
        <div class="input-row">
          <input id="messageInput" placeholder="Say something — press Enter to send" autocomplete="off" />
          <button class="send-btn" id="sendBtn">send</button>
        </div>
       <div id="sendHint" style="font-size:.8rem;color:#888;margin-top:.25rem;"></div>
      </div>
    </section>
  </div>

  <!-- Auth modal with email verification -->
  <div id="authModal" class="modal-overlay active">
    <div class="modal-content">
      <h2>sign in / sign up</h2>
      <div id="signInForm">
        <div class="form-group">
          <label for="signInUsername">username</label>
          <input id="signInUsername" placeholder="your username" />
        </div>
        <div class="form-group">
          <label for="signInPassword">password</label>
          <input id="signInPassword" type="password" placeholder="your password" />
        </div>
        <div class="btn-group">
          <button id="signInBtn" class="btn btn-primary">sign in</button>
          <button id="showSignUpBtn" class="btn btn-secondary">need an account?</button>
        </div>
        <p id="signInError" class="error-msg"></p>
      </div>

      <div id="signUpForm" style="display:none;">
        <div class="form-group">
          <label for="authEmail">email</label>
          <input id="authEmail" type="email" placeholder="your@email.com" />
        </div>
        <div class="form-group">
          <label for="authUsername">username</label>
          <input id="authUsername" placeholder="choose a unique username" />
        </div>
        <div class="form-group">
          <label for="authPassword">password</label>
          <input id="authPassword" type="password" placeholder="secure password" />
        </div>
        <div class="btn-group">
          <button id="signUpBtn" class="btn btn-primary">sign up</button>
          <button id="showSignInBtn" class="btn btn-secondary">have an account?</button>
        </div>
        <p class="info-msg">email verification required for new accounts</p>
        <p id="authError" class="error-msg"></p>
      </div>
    </div>
  </div>

  <!-- Profile modal -->
  <div id="profileModal" class="modal-overlay">
    <div class="modal-content profile-modal">
      <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar">U</div>
        <div class="profile-username" id="profileUsername">username</div>
        <div class="profile-status" id="profileStatus">online</div>
      </div>
      <div class="profile-bio" id="profileBio">no bio set</div>
      <div class="profile-actions">
        <button class="btn btn-primary" id="dmUserBtn"><i class='bx bx-message'></i> send DM</button>
        <button class="btn btn-secondary" id="closeProfileBtn">close</button>
      </div>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="settingsModal" class="modal-overlay">
    <div class="modal-content settings-modal">
      <h2>settings</h2>
      
      <div class="settings-section">
        <h3>account</h3>
        <div class="form-group">
          <label for="newUsername">change username</label>
          <input id="newUsername" placeholder="new username" />
        </div>
        <button class="btn btn-primary" id="updateUsernameBtn">update username</button>
      </div>

      <div class="settings-section">
        <h3>profile</h3>
        <div class="form-group">
          <label for="userBio">bio</label>
          <input id="userBio" placeholder="tell others about yourself" maxlength="150" />
        </div>
        <button class="btn btn-primary" id="updateBioBtn">update bio</button>
      </div>

      <div class="settings-section">
        <h3>notifications</h3>
        <div class="setting-item">
          <label>sound notifications</label>
          <div class="toggle-switch" id="soundToggle"></div>
        </div>
        <div class="setting-item">
          <label>desktop notifications</label>
          <div class="toggle-switch" id="desktopToggle"></div>
        </div>
      </div>

      <div class="settings-section">
        <h3>privacy</h3>
        <div class="setting-item">
          <label>show online status</label>
          <div class="toggle-switch active" id="onlineToggle"></div>
        </div>
      </div>

      <button class="btn btn-secondary" id="closeSettingsBtn">close</button>
      <p id="settingsError" class="error-msg"></p>
    </div>
  </div>

  <!-- Ban modal -->
  <div id="banModal" class="modal-overlay">
    <div class="ban-modal">
      <h3>account banned</h3>
      <p id="banReason">you have been banned from chat.</p>
      <button class="btn" id="closeBanBtn">ok</button>
    </div>
  </div>

  <!-- Add custom context menu -->
  <div class="context-menu" id="contextMenu">
    <div class="context-menu-item" id="ctxReply">
      <i class='bx bx-reply'></i> reply to message
    </div>
    <div class="context-menu-item" id="ctxCopy">
      <i class='bx bx-copy'></i> copy text
    </div>
    <div class="context-menu-item danger" id="ctxReport">
      <i class='bx bx-flag'></i> report message
    </div>
  </div>

  <!-- Add admin notification popup -->
  <div class="admin-notification" id="adminNotification">
    <div class="notif-header">
      <div class="notif-title">
        <i class='bx bx-error-circle'></i> message reported
      </div>
      <button class="notif-close" onclick="closeAdminNotif()"><i class='bx bx-x'></i></button>
    </div>
    <div class="notif-body" id="notifBody"></div>
    <div class="notif-meta" id="notifMeta"></div>
  </div>

  <!-- Add chat shutdown modal -->
  <div class="shutdown-modal" id="shutdownModal">
    <div class="shutdown-content">
      <div class="shutdown-icon"><i class='bx bx-error-circle'></i></div>
      <h2>chat shutdown</h2>
      <p>the chat has been temporarily shut down by an administrator. please check back later.</p>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBYyJuTAkVPB_65NqSeca6IueMoMO1iPzs",
      authDomain: "polars-shack.firebaseapp.com",
      projectId: "polars-shack",
      storageBucket: "polars-shack.firebasestorage.app",
      messagingSenderId: "205388124682",
      appId: "1:205388124682:web:2b0b1605517e0c6c53c5f3"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const rtdb = firebase.database();

    const offensiveWords = ['badword1', 'badword2', 'offensive', 'inappropriate'];
    function containsOffensive(text) {
      const lower = text.toLowerCase();
      return offensiveWords.some(word => lower.includes(word));
    }

    const settings = {
  chatShutdown: false,
  lockdown: false,
  slowMode: 0,               // seconds
  lastSentAt: 0,             // per-session cache
};

    // paste your block RIGHT HERE:
function renderSendHint(){
  const el = document.getElementById('sendHint');
  if (!el) return;
  if (settings.chatShutdown) el.textContent = 'Chat is shut down by an admin.';
  else if (settings.lockdown) el.textContent = 'Lockdown is active. Only admins can send messages.';
  else if (settings.slowMode > 0) el.textContent = `Slow mode: ${settings.slowMode}s`;
  else el.textContent = '';
}
['chatShutdown','lockdown','slowMode'].forEach(k=>{
  Object.defineProperty(settings, k, {
    set(v){ this['_' + k] = v; renderSendHint(); },
    get(){ return this['_' + k]; }
  });
});
renderSendHint();

function nowMs(){ return Date.now(); }
function secondsLeft(endMs){ return Math.max(0, Math.ceil((endMs - nowMs())/1000)); }

    let lastMessage = '';
    let lastMessageTime = 0;

    let replyingTo = null;

    let contextMenuTarget = null;

    let currentUser = null;
    let currentRoom = 'public';
    let unsubscribeMessages = null;
    let dmRooms = [];
    let unreadDMs = {};

    // existing: shutdown modal listener (keep it)
rtdb.ref('settings/chatShutdown').on('value', s => {
  settings.chatShutdown = !!s.val();
  document.getElementById('shutdownModal').classList.toggle('active', settings.chatShutdown);
});

// add these two listeners
rtdb.ref('settings/lockdown').on('value', s => {
  settings.lockdown = !!s.val();
});

rtdb.ref('settings/slowMode').on('value', s => {
  const v = s.val();
  settings.slowMode = typeof v === 'number' && v > 0 ? v : 0;
});

    document.getElementById('signUpBtn').addEventListener('click', signUp);
    document.getElementById('signInBtn').addEventListener('click', signIn);
    document.getElementById('logoutBtn').addEventListener('click', logout);
    document.getElementById('settingsBtn').addEventListener('click', () => {
      if (currentUser) {
        document.getElementById('newUsername').value = currentUser.username;
        document.getElementById('userBio').value = currentUser.bio || '';
      }
      document.getElementById('settingsModal').classList.add('active');
    });
    document.getElementById('closeSettingsBtn').addEventListener('click', () => {
      document.getElementById('settingsModal').classList.remove('active');
    });
    document.getElementById('closeProfileBtn').addEventListener('click', () => {
      document.getElementById('profileModal').classList.remove('active');
    });
    document.getElementById('closeBanBtn').addEventListener('click', () => {
      document.getElementById('banModal').classList.remove('active');
    });

    document.getElementById('updateUsernameBtn').addEventListener('click', async () => {
      const newUsername = document.getElementById('newUsername').value.trim();
      
      if (!newUsername) {
        document.getElementById('settingsError').textContent = 'Username cannot be empty';
        document.getElementById('settingsError').style.display = 'block';
        return;
      }

      if (containsOffensive(newUsername)) {
        document.getElementById('settingsError').textContent = 'Username contains inappropriate content';
        document.getElementById('settingsError').style.display = 'block';
        return;
      }

      // Check if username is already taken
      const usernameQuery = await db.collection('users').where('username', '==', newUsername).get();
      if (!usernameQuery.empty && usernameQuery.docs[0].id !== currentUser.uid) {
        document.getElementById('settingsError').textContent = 'Username already taken';
        document.getElementById('settingsError').style.display = 'block';
        return;
      }

      try {
        await db.collection('users').doc(currentUser.uid).update({ username: newUsername });
        currentUser.username = newUsername;
        document.getElementById('meDisplay').textContent = `@${newUsername}`;
        document.getElementById('settingsError').textContent = 'Username updated successfully!';
        document.getElementById('settingsError').style.color = '#00ff00';
        document.getElementById('settingsError').style.display = 'block';
        setTimeout(() => {
          document.getElementById('settingsError').style.display = 'none';
          document.getElementById('settingsError').style.color = '#ff6666';
        }, 3000);
      } catch (error) {
        document.getElementById('settingsError').textContent = 'Failed to update username';
        document.getElementById('settingsError').style.display = 'block';
      }
    });

    document.getElementById('updateBioBtn').addEventListener('click', async () => {
      const newBio = document.getElementById('userBio').value.trim();

      if (containsOffensive(newBio)) {
        document.getElementById('settingsError').textContent = 'Bio contains inappropriate content';
        document.getElementById('settingsError').style.display = 'block';
        return;
      }

      try {
        await db.collection('users').doc(currentUser.uid).update({ bio: newBio });
        currentUser.bio = newBio;
        document.getElementById('settingsError').textContent = 'Bio updated successfully!';
        document.getElementById('settingsError').style.color = '#00ff00';
        document.getElementById('settingsError').style.display = 'block';
        setTimeout(() => {
          document.getElementById('settingsError').style.display = 'none';
          document.getElementById('settingsError').style.color = '#ff6666';
        }, 3000);
      } catch (error) {
        document.getElementById('settingsError').textContent = 'Failed to update bio';
        document.getElementById('settingsError').style.display = 'block';
      }
    });

    document.getElementById('soundToggle').addEventListener('click', function() {
      this.classList.toggle('active');
      const enabled = this.classList.contains('active');
      localStorage.setItem('soundNotifications', enabled);
    });

    document.getElementById('desktopToggle').addEventListener('click', function() {
      this.classList.toggle('active');
      const enabled = this.classList.contains('active');
      localStorage.setItem('desktopNotifications', enabled);
      if (enabled && 'Notification' in window) {
        Notification.requestPermission();
      }
    });

    document.getElementById('onlineToggle').addEventListener('click', async function() {
      this.classList.toggle('active');
      const enabled = this.classList.contains('active');
      if (currentUser) {
        await db.collection('users').doc(currentUser.uid).update({ showOnlineStatus: enabled });
      }
    });

    document.getElementById('dmUserBtn').addEventListener('click', async () => {
      const profileUsername = document.getElementById('profileUsername').textContent;
      
      // Find the user by username
      const userQuery = await db.collection('users').where('username', '==', profileUsername).get();
      if (userQuery.empty) return;
      
      const targetUser = { uid: userQuery.docs[0].id, ...userQuery.docs[0].data() };
      
      // Create DM room ID (sorted UIDs to ensure consistency)
      const roomId = [currentUser.uid, targetUser.uid].sort().join('_');
      
      // Check if DM room already exists
      if (!dmRooms.find(room => room.id === roomId)) {
        dmRooms.push({
          id: roomId,
          name: `@${targetUser.username}`,
          type: 'dm',
          participants: [currentUser.uid, targetUser.uid]
        });
        
        // Save DM room to user's account
        await db.collection('users').doc(currentUser.uid).update({
          dmRooms: firebase.firestore.FieldValue.arrayUnion({
            roomId,
            withUser: targetUser.uid,
            withUsername: targetUser.username
          })
        });
        
        renderRoomTabs();
      }
      
      // Switch to DM room
      switchRoom(roomId);
      document.getElementById('profileModal').classList.remove('active');
    });

    document.getElementById('cancelReply').addEventListener('click', () => {
      replyingTo = null;
      document.getElementById('replyIndicator').classList.remove('active');
    });

    const contextMenu = document.getElementById('contextMenu');
    document.addEventListener('contextmenu', (e) => {
      const msgEl = e.target.closest('.msg');
      if (msgEl && !msgEl.classList.contains('system')) {
        e.preventDefault();
        contextMenuTarget = msgEl;
        contextMenu.style.left = e.pageX + 'px';
        contextMenu.style.top = e.pageY + 'px';
        contextMenu.classList.add('active');
      }
    });

    document.addEventListener('click', () => {
      contextMenu.classList.remove('active');
    });

    document.getElementById('ctxReply').addEventListener('click', () => {
      if (contextMenuTarget) {
        const username = contextMenuTarget.querySelector('.username').textContent;
        const content = contextMenuTarget.querySelector('.content').textContent;
        replyingTo = { username, content };
        document.getElementById('replyText').textContent = `replying to ${username}`;
        document.getElementById('replyIndicator').classList.add('active');
        document.getElementById('messageInput').focus();
      }
    });

    document.getElementById('ctxCopy').addEventListener('click', () => {
      if (contextMenuTarget) {
        const content = contextMenuTarget.querySelector('.content').textContent;
        navigator.clipboard.writeText(content);
      }
    });

    document.getElementById('ctxReport').addEventListener('click', () => {
      if (contextMenuTarget) {
        const username = contextMenuTarget.querySelector('.username').textContent;
        const content = contextMenuTarget.querySelector('.content').textContent;
        const timestamp = contextMenuTarget.querySelector('.meta span:last-child').textContent;
        reportMessage(username, content, timestamp);
      }
    });

    async function reportMessage(username, content, timestamp) {
      const reportData = {
        reporter: currentUser.username,
        reporterUid: currentUser.uid,
        reportedUser: username,
        message: content,
        messageTime: timestamp,
        room: currentRoom,
        timestamp: Date.now(),
        status: 'pending'
      };

      try {
        // Save report to database
        await db.collection('reports').add(reportData);
        
        // Show confirmation to reporter
        alert('Message reported successfully. Admins will review it shortly.');
        
        // Notify all online admins in real-time
        const adminsSnapshot = await db.collection('users').where('isAdmin', '==', true).where('online', '==', true).get();
        
        adminsSnapshot.forEach(async (doc) => {
          const adminData = doc.data();
          // Create notification for admin
          await db.collection('notifications').add({
            recipientUid: doc.id,
            type: 'report',
            title: 'New Message Report',
            body: `User "${username}" reported by ${currentUser.username}`,
            message: content,
            timestamp: Date.now(),
            read: false
          });
        });
        
        // Show notification to admins who are currently online
        notifyOnlineAdmins(username, content, timestamp);
      } catch (error) {
        console.error('[v0] Report error:', error);
        alert('Failed to submit report. Please try again.');
      }
    }

    function notifyOnlineAdmins(reportedUser, message, timestamp) {
      // Listen for admin notifications if current user is admin
      if (currentUser && currentUser.isAdmin) {
        const notif = document.getElementById('adminNotification');
        document.getElementById('notifBody').innerHTML = `
          <strong>Reported User:</strong> ${reportedUser}<br>
          <strong>Message:</strong> "${message}"<br>
          <strong>Time:</strong> ${timestamp}
        `;
        document.getElementById('notifMeta').textContent = `Reported by: ${currentUser.username} at ${new Date().toLocaleTimeString()}`;
        notif.classList.add('active');
        
        // Auto-hide after 15 seconds
        setTimeout(() => notif.classList.remove('active'), 15000);
      }
    }

    function closeAdminNotif() {
      document.getElementById('adminNotification').classList.remove('active');
    }

    rtdb.ref('settings/chatShutdown').on('value', (snapshot) => {
      const isShutdown = snapshot.val();
      if (isShutdown) {
        document.getElementById('shutdownModal').classList.add('active');
      } else {
        document.getElementById('shutdownModal').classList.remove('active');
      }
    });

    async function signUp() {
      const email = document.getElementById('authEmail').value;
      const username = document.getElementById('authUsername').value;
      const password = document.getElementById('authPassword').value;

      if (containsOffensive(username)) {
        document.getElementById('authError').textContent = 'Username contains inappropriate content';
        document.getElementById('authError').style.display = 'block';
        return;
      }

      try {
        const userCred = await auth.createUserWithEmailAndPassword(email, password);
        await db.collection('users').doc(userCred.user.uid).set({
          username,
          email,
          createdAt: Date.now(),
          isAdmin: false,
          isBanned: false,
          online: true,
          bio: '',
          dmRooms: [],
          showOnlineStatus: true
        });
        document.getElementById('authModal').classList.remove('active');
      } catch (error) {
        document.getElementById('authError').textContent = error.message;
        document.getElementById('authError').style.display = 'block';
      }
    }

    async function signIn() {
      const username = document.getElementById('signInUsername').value.trim();
      const password = document.getElementById('signInPassword').value;

      if (!username || !password) {
        document.getElementById('signInError').textContent = 'Please enter username and password';
        document.getElementById('signInError').style.display = 'block';
        return;
      }

      try {
        // Find user by username
        const userQuery = await db.collection('users').where('username', '==', username).limit(1).get();
        
        if (userQuery.empty) {
          document.getElementById('signInError').textContent = 'Username not found';
          document.getElementById('signInError').style.display = 'block';
          return;
        }

        const userDoc = userQuery.docs[0];
        const userData = userDoc.data();
        
        // Sign in with email and password
        await auth.signInWithEmailAndPassword(userData.email, password);
        document.getElementById('authModal').classList.remove('active');
        document.getElementById('signInError').style.display = 'none';
      } catch (error) {
        console.error('[v0] Sign in error:', error);
        document.getElementById('signInError').textContent = 'Invalid username or password';
        document.getElementById('signInError').style.display = 'block';
      }
    }

    function logout() {
      auth.signOut();
    }

    auth.onAuthStateChanged(async (user) => {
      console.log('[v0] Auth state changed:', user ? user.uid : 'no user');
      if (user) {
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
          currentUser = { uid: user.uid, ...userDoc.data() };
          console.log('[v0] Current user loaded:', currentUser);
          
          if (currentUser.isBanned) {
            document.getElementById('banModal').classList.add('active');
            document.getElementById('banReason').textContent = currentUser.banReason || 'You have been banned from chat.';
            auth.signOut();
            return;
          }

          document.getElementById('meDisplay').textContent = `@${currentUser.username}`;
          await db.collection('users').doc(user.uid).update({ online: true });
          
          if (currentUser.dmRooms && currentUser.dmRooms.length > 0) {
            dmRooms = currentUser.dmRooms.map(dm => ({
              id: dm.roomId,
              name: `@${dm.withUsername}`,
              type: 'dm',
              participants: [currentUser.uid, dm.withUser]
            }));
            renderRoomTabs();
          }
          
          loadMessages();
          loadOnlineUsers();
          
          // Load saved settings
          const soundEnabled = localStorage.getItem('soundNotifications') !== 'false';
          const desktopEnabled = localStorage.getItem('desktopNotifications') === 'true';
          if (soundEnabled) document.getElementById('soundToggle').classList.add('active');
          if (desktopEnabled) document.getElementById('desktopToggle').classList.add('active');
          if (currentUser.showOnlineStatus !== false) document.getElementById('onlineToggle').classList.add('active');
          
          console.log('[v0] Messages and users loaded');
        } else {
          console.error('[v0] User document does not exist');
        }
      } else {
        currentUser = null;
        document.getElementById('authModal').classList.add('active');
        document.getElementById('meDisplay').textContent = '@guest';
      }
    });

    function switchRoom(roomId) {
      currentRoom = roomId;
      loadMessages();
      
      if (unreadDMs[roomId]) {
        delete unreadDMs[roomId];
        renderRoomTabs();
      }
      
      // Update active tab
      document.querySelectorAll('.room-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.room === roomId) {
          tab.classList.add('active');
        }
      });
      
      // Update chat title
      const room = dmRooms.find(r => r.id === roomId);
      if (room) {
        document.getElementById('chatTitle').textContent = `DM with ${room.name}`;
      } else {
        document.getElementById('chatTitle').textContent = 'public chat';
      }
    }

    function renderRoomTabs() {
      const tabsContainer = document.getElementById('roomTabs');
      tabsContainer.innerHTML = `
        <div class="room-tab ${currentRoom === 'public' ? 'active' : ''}" data-room="public">
          <i class='bx bx-globe'></i> public chat
        </div>
      `;
      
      dmRooms.forEach(room => {
        const tab = document.createElement('div');
        tab.className = `room-tab ${currentRoom === room.id ? 'active' : ''}`;
        tab.dataset.room = room.id;
        
        const hasUnread = unreadDMs[room.id];
        const notifDot = hasUnread ? '<span style="width:8px;height:8px;background:#ff6666;border-radius:50%;display:inline-block;margin-left:4px;box-shadow:0 0 8px #ff6666;"></span>' : '';
        
        tab.innerHTML = `
          <i class='bx bx-message'></i> ${room.name}${notifDot}
          <span class="close-dm" data-room="${room.id}">×</span>
        `;
        tab.addEventListener('click', (e) => {
          if (!e.target.classList.contains('close-dm')) {
            switchRoom(room.id);
          }
        });
        
        // Close DM functionality
        tab.querySelector('.close-dm').addEventListener('click', async (e) => {
          e.stopPropagation();
          dmRooms = dmRooms.filter(r => r.id !== room.id);
          await db.collection('users').doc(currentUser.uid).update({
            dmRooms: dmRooms.map(r => ({
              roomId: r.id,
              withUser: r.participants.find(uid => uid !== currentUser.uid),
              withUsername: r.name.substring(1)
            }))
          });
          if (currentRoom === room.id) {
            switchRoom('public');
          }
          renderRoomTabs();
        });
        
        tabsContainer.appendChild(tab);
      });
      
      // Add click handlers to public tab
      tabsContainer.querySelector('[data-room="public"]').addEventListener('click', () => {
        switchRoom('public');
      });
    }

    function loadMessages() {
      if (unsubscribeMessages) unsubscribeMessages();

      unsubscribeMessages = db.collection('messages')
        .where('room', '==', currentRoom)
        .orderBy('timestamp', 'asc')
        .limit(100)
        .onSnapshot((snapshot) => {
          const messagesDiv = document.getElementById('messages');
          messagesDiv.innerHTML = '';

          snapshot.forEach((doc) => {
            const msg = doc.data();
            const msgEl = document.createElement('div');
            msgEl.className = `msg ${msg.uid === currentUser.uid ? 'me' : msg.type === 'system' ? 'system' : 'other'}`;
            
            if (msg.type === 'system') {
              msgEl.innerHTML = `<div class="content">${msg.text}</div>`;
            } else {
              let replyHTML = '';
              if (msg.replyTo) {
                replyHTML = `<div class="reply-preview"><div class="reply-to">@${msg.replyTo.username}</div>${msg.replyTo.content}</div>`;
              }
              
              msgEl.innerHTML = `
                <div class="meta">
                  <span class="username">${msg.username}</span>
                  ${msg.isAdmin ? '<span class="admin-tag">ADMIN</span>' : ''}
                  <span>${new Date(msg.timestamp).toLocaleTimeString()}</span>
                </div>
                ${replyHTML}
                <div class="content">${msg.text}</div>
              `;
            }

            messagesDiv.appendChild(msgEl);
          });

          messagesDiv.scrollTop = messagesDiv.scrollHeight;
          
          if (currentRoom !== 'public' && currentRoom !== currentUser.uid) {
            const lastMsg = snapshot.docs[snapshot.docs.length - 1];
            if (lastMsg && lastMsg.data().uid !== currentUser.uid && currentRoom !== currentRoom) {
              unreadDMs[currentRoom] = true;
              renderRoomTabs();
            }
          }
        });
      
      dmRooms.forEach(room => {
        if (room.id !== currentRoom) {
          db.collection('messages')
            .where('room', '==', room.id)
            .orderBy('timestamp', 'desc')
            .limit(1)
            .onSnapshot((snapshot) => {
              if (!snapshot.empty) {
                const lastMsg = snapshot.docs[0].data();
                if (lastMsg.uid !== currentUser.uid && lastMsg.timestamp > Date.now() - 5000) {
                  unreadDMs[room.id] = true;
                  renderRoomTabs();
                }
              }
            });
        }
      });
    }

    function loadOnlineUsers() {
      db.collection('users').where('online', '==', true).onSnapshot((snapshot) => {
        const usersDiv = document.getElementById('usersList');
        usersDiv.innerHTML = '';

        snapshot.forEach((doc) => {
          const user = doc.data();
          const userEl = document.createElement('div');
          userEl.className = 'user-row';
          userEl.innerHTML = `
            <div>
              <div class="user-name">${user.username}${user.isAdmin ? '<span class="badge-admin">ADMIN</span>' : ''}</div>
              <div class="user-meta"><span class="status-dot online"></span>online</div>
            </div>
          `;
          userEl.addEventListener('click', () => showProfile(user));
          usersDiv.appendChild(userEl);
        });
      });
    }

    function showProfile(user) {
      document.getElementById('profileModal').classList.add('active');
      document.getElementById('profileAvatar').textContent = user.username[0].toUpperCase();
      document.getElementById('profileUsername').textContent = user.username;
      document.getElementById('profileStatus').textContent = user.online ? 'online' : 'offline';
      document.getElementById('profileBio').textContent = user.bio || 'no bio set';
    }

    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); sendMessage(); }
  });

    async function sendMessage() {
  const input = document.getElementById('messageInput');
  const textRaw = (input.value || '');
  const text = textRaw.trim();
  if (!text) return;
  if (!currentUser) { alert('Sign in to chat.'); return; }

  // --- ADMIN COMMANDS FIRST (so admins can act during shutdown/lockdown) ---
  if (text.startsWith('/') && !!currentUser.isAdmin) {
    await handleAdminCommand(text);
    input.value = '';
    return;
  }

  // --- Global switches ---
  if (settings.chatShutdown) { alert('Chat is shut down by an admin.'); return; }
  if (settings.lockdown && !currentUser.isAdmin) { alert('Chat is in lockdown.'); return; }

  // User state (fresh read to avoid stale client-only state)
  const meDoc = await db.collection('users').doc(currentUser.uid).get();
  const me = meDoc.exists ? meDoc.data() : currentUser;

  if (me.isBanned) {
    document.getElementById('banModal').classList.add('active');
    document.getElementById('banReason').textContent = me.banReason || 'You have been banned from chat.';
    await auth.signOut();
    return;
  }

  if (me.isMuted) {
    const until = typeof me.muteUntil === 'number' ? me.muteUntil :
                  (me.muteUntil && me.muteUntil.toMillis ? me.muteUntil.toMillis() : 0);
    const wait = until ? secondsLeft(until) : null;
    alert(wait ? `You are muted for ${wait} more second(s).` : 'You are muted.');
    return;
  }

  // Content checks
  if (containsOffensive(text)) { alert('Message blocked by content filter.'); return; }

  // Per-user slowmode (RTDB setting)
  if (settings.slowMode > 0 && !me.isAdmin) {
    const elapsed = (nowMs() - settings.lastSentAt) / 1000;
    if (elapsed < settings.slowMode) {
      alert(`Slow mode is on. Wait ${Math.ceil(settings.slowMode - elapsed)}s.`);
      return;
    }
  }

  // Per-device anti-spam (existing)
  const now = nowMs();
  if (text === lastMessage && now - lastMessageTime < 3000) {
    alert('Please do not spam the same message.');
    return;
  }

  // Build message
  const messageData = {
    uid: currentUser.uid,
    username: currentUser.username,
    isAdmin: !!currentUser.isAdmin,
    text,
    room: currentRoom,
    timestamp: now
  };
  if (replyingTo) {
    messageData.replyTo = replyingTo;
    replyingTo = null;
    document.getElementById('replyIndicator').classList.remove('active');
  }

  await db.collection('messages').add(messageData);
  settings.lastSentAt = now;
  lastMessage = text;
  lastMessageTime = now;
  input.value = '';
}

    async function handleAdminCommand(command) {
      const parts = command.split(' ');
      const cmd = parts[0].toLowerCase();
      const args = parts.slice(1);

      console.log('[v0] Admin command:', cmd, args);

      try {
        switch(cmd) {
          case '/ban':
            if (args.length < 1) {
              alert('Usage: /ban <username> [reason]');
              return;
            }
            await banUser(args[0], args.slice(1).join(' ') || 'No reason provided');
            break;

          case '/unban':
            if (args.length < 1) {
              alert('Usage: /unban <username>');
              return;
            }
            await unbanUser(args[0]);
            break;

          case '/kick':
            if (args.length < 1) {
              alert('Usage: /kick <username>');
              return;
            }
            await kickUser(args[0]);
            break;

          case '/mute':
            if (args.length < 2) {
              alert('Usage: /mute <username> <minutes>');
              return;
            }
            await muteUser(args[0], parseInt(args[1]));
            break;

          case '/unmute':
            if (args.length < 1) {
              alert('Usage: /unmute <username>');
              return;
            }
            await unmuteUser(args[0]);
            break;

          case '/clear':
            await clearChat();
            break;

          case '/announce':
            if (args.length < 1) {
              alert('Usage: /announce <message>');
              return;
            }
            await sendAnnouncement(args.join(' '));
            break;

          case '/warn':
            if (args.length < 2) {
              alert('Usage: /warn <username> <message>');
              return;
            }
            await warnUser(args[0], args.slice(1).join(' '));
            break;

          case '/promote':
            if (args.length < 1) {
              alert('Usage: /promote <username>');
              return;
            }
            await promoteUser(args[0]);
            break;

          case '/demote':
            if (args.length < 1) {
              alert('Usage: /demote <username>');
              return;
            }
            await demoteUser(args[0]);
            break;

          case '/shutdown':
            await shutdownChat();
            break;

          case '/restart':
            await restartChat();
            break;

          case '/slowmode':
            if (args.length < 1) {
              alert('Usage: /slowmode <seconds>');
              return;
            }
            await setSlowMode(parseInt(args[0]));
            break;

          case '/lockdown':
            await toggleLockdown();
            break;

          case '/purge':
            if (args.length < 1) {
              alert('Usage: /purge <username>');
              return;
            }
            await purgeUserMessages(args[0]);
            break;

          case '/stats':
            await showStats();
            break;

          case '/help':
            showAdminHelp();
            break;

          default:
            alert(`Unknown command: ${cmd}\nType /help for a list of commands`);
        }
      } catch (error) {
        console.error('[v0] Command error:', error);
        alert(`Error executing command: ${error.message}`);
      }
    }

    async function banUser(username, reason) {
      const userQuery = await db.collection('users').where('username', '==', username).get();
      if (userQuery.empty) {
        alert('User not found');
        return;
      }

      const userDoc = userQuery.docs[0];
      await db.collection('users').doc(userDoc.id).update({
        isBanned: true,
        banReason: reason,
        bannedBy: currentUser.username,
        bannedAt: Date.now()
      });

      await db.collection('messages').add({
        type: 'system',
        text: `${username} has been banned by ${currentUser.username}. Reason: ${reason}`,
        room: 'public',
        timestamp: Date.now()
      });

      alert(`${username} has been banned`);
    }

    async function unbanUser(username) {
      const userQuery = await db.collection('users').where('username', '==', username).get();
      if (userQuery.empty) {
        alert('User not found');
        return;
      }

      const userDoc = userQuery.docs[0];
      await db.collection('users').doc(userDoc.id).update({
        isBanned: false,
        banReason: null,
        bannedBy: null,
        bannedAt: null
      });

      await db.collection('messages').add({
        type: 'system',
        text: `${username} has been unbanned by ${currentUser.username}`,
        room: 'public',
        timestamp: Date.now()
      });

      alert(`${username} has been unbanned`);
    }

    async function kickUser(username) {
      const userQuery = await db.collection('users').where('username', '==', username).get();
      if (userQuery.empty) {
        alert('User not found');
        return;
      }

      const userDoc = userQuery.docs[0];
      await db.collection('users').doc(userDoc.id).update({ online: false });

      await db.collection('messages').add({
        type: 'system',
        text: `${username} has been kicked by ${currentUser.username}`,
        room: 'public',
        timestamp: Date.now()
      });

      alert(`${username} has been kicked`);
    }

    async function muteUser(username, minutes) {
      const userQuery = await db.collection('users').where('username', '==', username).get();
      if (userQuery.empty) {
        alert('User not found');
        return;
      }

      const userDoc = userQuery.docs[0];
      const muteUntil = Date.now() + (minutes * 60 * 1000);
      
      await db.collection('users').doc(userDoc.id).update({
        isMuted: true,
        muteUntil: muteUntil,
        mutedBy: currentUser.username
      });

      await db.collection('messages').add({
        type: 'system',
        text: `${username} has been muted for ${minutes} minutes by ${currentUser.username}`,
        room: 'public',
        timestamp: Date.now()
      });

      alert(`${username} has been muted for ${minutes} minutes`);
    }

    async function unmuteUser(username) {
      const userQuery = await db.collection('users').where('username', '==', username).get();
      if (userQuery.empty) {
        alert('User not found');
        return;
      }

      const userDoc = userQuery.docs[0];
      await db.collection('users').doc(userDoc.id).update({
        isMuted: false,
        muteUntil: null,
        mutedBy: null
      });

      await db.collection('messages').add({
        type: 'system',
        text: `${username} has been unmuted by ${currentUser.username}`,
        room: 'public',
        timestamp: Date.now()
      });

      alert(`${username} has been unmuted`);
    }

    async function clearChat() {
      const messagesQuery = await db.collection('messages').where('room', '==', currentRoom).get();
      const batch = db.batch();
      messagesQuery.docs.forEach(doc => batch.delete(doc.ref));
      await batch.commit();

      await db.collection('messages').add({
        type: 'system',
        text: `Chat cleared by ${currentUser.username}`,
        room: currentRoom,
        timestamp: Date.now()
      });

      alert('Chat has been cleared');
    }

    async function sendAnnouncement(message) {
      await db.collection('messages').add({
        type: 'system',
        text: `📢 ANNOUNCEMENT: ${message}`,
        room: 'public',
        timestamp: Date.now()
      });

      alert('Announcement sent');
    }

    async function warnUser(username, message) {
      const userQuery = await db.collection('users').where('username', '==', username).get();
      if (userQuery.empty) {
        alert('User not found');
        return;
      }

      await db.collection('messages').add({
        type: 'system',
        text: `⚠️ ${username} has been warned by ${currentUser.username}: ${message}`,
        room: 'public',
        timestamp: Date.now()
      });

      alert(`Warning sent to ${username}`);
    }

    async function promoteUser(username) {
      const userQuery = await db.collection('users').where('username', '==', username).get();
      if (userQuery.empty) {
        alert('User not found');
        return;
      }

      const userDoc = userQuery.docs[0];
      await db.collection('users').doc(userDoc.id).update({ isAdmin: true });

      await db.collection('messages').add({
        type: 'system',
        text: `${username} has been promoted to admin by ${currentUser.username}`,
        room: 'public',
        timestamp: Date.now()
      });

      alert(`${username} has been promoted to admin`);
    }

    async function demoteUser(username) {
      const userQuery = await db.collection('users').where('username', '==', username).get();
      if (userQuery.empty) {
        alert('User not found');
        return;
      }

      const userDoc = userQuery.docs[0];
      await db.collection('users').doc(userDoc.id).update({ isAdmin: false });

      await db.collection('messages').add({
        type: 'system',
        text: `${username} has been demoted by ${currentUser.username}`,
        room: 'public',
        timestamp: Date.now()
      });

      alert(`${username} has been demoted`);
    }

    async function shutdownChat() {
      await rtdb.ref('settings/chatShutdown').set(true);
      
      await db.collection('messages').add({
        type: 'system',
        text: `🔒 Chat has been shut down by ${currentUser.username}`,
        room: 'public',
        timestamp: Date.now()
      });

      alert('Chat has been shut down');
    }

    async function restartChat() {
      await rtdb.ref('settings/chatShutdown').set(false);
      
      await db.collection('messages').add({
        type: 'system',
        text: `✅ Chat has been restarted by ${currentUser.username}`,
        room: 'public',
        timestamp: Date.now()
      });

      alert('Chat has been restarted');
    }

    async function setSlowMode(seconds) {
      await rtdb.ref('settings/slowMode').set(seconds);
      
      await db.collection('messages').add({
        type: 'system',
        text: `⏱️ Slow mode set to ${seconds} seconds by ${currentUser.username}`,
        room: 'public',
        timestamp: Date.now()
      });

      alert(`Slow mode set to ${seconds} seconds`);
    }

    async function toggleLockdown() {
      const lockdownRef = rtdb.ref('settings/lockdown');
      const snapshot = await lockdownRef.once('value');
      const isLocked = snapshot.val() || false;
      
      await lockdownRef.set(!isLocked);
      
      await db.collection('messages').add({
        type: 'system',
        text: `🔐 Lockdown ${!isLocked ? 'enabled' : 'disabled'} by ${currentUser.username}`,
        room: 'public',
        timestamp: Date.now()
      });

      alert(`Lockdown ${!isLocked ? 'enabled' : 'disabled'}`);
    }

    async function purgeUserMessages(username) {
      const messagesQuery = await db.collection('messages').where('username', '==', username).get();
      const batch = db.batch();
      messagesQuery.docs.forEach(doc => batch.delete(doc.ref));
      await batch.commit();

      await db.collection('messages').add({
        type: 'system',
        text: `All messages from ${username} have been purged by ${currentUser.username}`,
        room: 'public',
        timestamp: Date.now()
      });

      alert(`All messages from ${username} have been purged`);
    }

    async function showStats() {
      const usersSnapshot = await db.collection('users').get();
      const messagesSnapshot = await db.collection('messages').get();
      const onlineUsers = usersSnapshot.docs.filter(doc => doc.data().online).length;
      
      alert(`
📊 Chat Statistics:
Total Users: ${usersSnapshot.size}
Online Users: ${onlineUsers}
Total Messages: ${messagesSnapshot.size}
Current Room: ${currentRoom}
      `);
    }

    function showAdminHelp() {
      alert(`
🛠️ Admin Commands:
/ban <user> [reason] - Ban a user
/unban <user> - Unban a user
/kick <user> - Kick a user
/mute <user> <minutes> - Mute a user
/unmute <user> - Unmute a user
/warn <user> <message> - Warn a user
/promote <user> - Promote to admin
/demote <user> - Demote from admin
/clear - Clear chat messages
/purge <user> - Delete all user messages
/announce <message> - Send announcement
/slowmode <seconds> - Set slow mode
/lockdown - Toggle lockdown mode
/shutdown - Shutdown chat
/restart - Restart chat
/stats - Show statistics
/help - Show this help
      `);
    }

    window.addEventListener('beforeunload', () => {
      if (currentUser) {
        db.collection('users').doc(currentUser.uid).update({ online: false });
      }
    });

    document.getElementById('showSignUpBtn').addEventListener('click', () => {
      document.getElementById('signInForm').style.display = 'none';
      document.getElementById('signUpForm').style.display = 'block';
    });

    document.getElementById('showSignInBtn').addEventListener('click', () => {
      document.getElementById('signUpForm').style.display = 'none';
      document.getElementById('signInForm').style.display = 'block';
    });
  </script>
</body>
</html>
